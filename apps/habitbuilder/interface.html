<html>
  <head>
    <link rel="stylesheet" href="../../css/spectre.min.css">
  </head>
  <body>
    <h2>Data</h2>
    <div id="data"></div>
    <button class="btn btn-default" id="btnSave">Save</button>
    <button class="btn btn-default" id="btnDelete">Delete</button>
    <h2 style="margin-top: 20px">Settings</h2>
    <div id="settings"></div>
    <button class="btn btn-primary" id="btnSaveSettings">Save settings</button>

    <script src="../../core/lib/interface.js"></script>
    <script src="settings-form.js"></script>
    <script>
var dataElement = document.getElementById("data");
var csvData = "";

function getSettings() {
  // show loading window
  Util.showModal("Loading...");
  Util.readStorage('habitbuilder.settings.json', data=>{
    console.log("Settings: "+data);
    const settings = JSON.parse(data || "[]");

    // build settings form
    settingsHtml = buildSettingsForm(settings.questions, settings.reminderTime);
    document.getElementById("settings").innerHTML = settingsHtml;

    document.getElementById("btnSaveSettings").addEventListener("click", function() {

      disableFormInput();

      // Get questions
      const settings = getSettingsFromForm();
      if (!settings) {
        return;
      }

      Util.writeStorage('habitbuilder.settings.json', JSON.stringify(settings), () => {
        location.reload(); // reload so we see current data
      });
    });

    // Didn't work in onInit, so call it here
    getData();
  });
}

function getData() {
  // get the data
  dataElement.innerHTML = "";
  Util.readStorageFile('habitbuilder.data.csv',data=>{
    csvData = data.trim();
    // remove window
    Util.hideModal();
    // If no data, report it and exit
    if (csvData.length==0) {
      dataElement.innerHTML = "<b>No data found</b>";
      return;
    }
    // Otherwise parse the data and output it as a table
    dataElement.innerHTML = `<table class="table" style="margin-bottom: 10px">
    <tr>
      <th>Question</th>
      <th>Date</th>
      <th>Answer</th>
    </tr>`+csvData.split("\n").map(l=>{
      l = l.split(",");
      return `<tr>
      <td>${l[0]}</td>
      <td>${l[1]}</td>
      <td>${l[2]}</td>
      </tr>`
    }).join("\n")+"</table>";
  });
}

// You can call a utility function to save the data
document.getElementById("btnSave").addEventListener("click", function() {
  Util.saveCSV("habitbuilder", csvData);
});
// Or you can also delete the file
document.getElementById("btnDelete").addEventListener("click", function() {
  Util.showModal("Deleting...");
  Util.eraseStorageFile("habitbuilder.data.csv", function() {
    Util.hideModal();
    getData();
  });
});

// Called when app starts
function onInit() {
  getSettings();
}

    </script>
  </body>
</html>
